<!DOCTYPE html>
<meta charset="utf-8">
<style>
	path {
		stroke: #fff;
	}

	#full-canvas{
		position: fixed;
		height: auto;
		width: auto;
		z-index: -1;
	}

	#tooltip {
		position: fixed;
		width: auto;
		height: auto;
		background-color: white;
		pointer-events: none;
		float: left;
		z-index: 1
	}
	#table{
		width: 20%;
		float: right;
		border: 1px solid black;
		border-collapse: collapse;
	}
	th {
		font-size: 20px;
		border: 1px solid black;
	}

	#tooltip.hidden {
		display: none;
	}

	#tooltip p {
		margin: 0;
		font-family: sans-serif;
		font-size: 16px;
		line-height: 20px;
	}

	.line {
		fill: none;
		stroke-width: 2;
	}

	.grid line {
		stroke: lightgrey;
		stroke-opacity: 0.7;
		shape-rendering: crispEdges;
	}

	.grid path {
		stroke-width: 0;
	}
</style>

<body>

<div class="sunburst-and-table">


	<div id="tooltip" class="hidden">
		//<p><span id="value">150</span>%</p>
	</div>
	<div id="table"></div>

</div>



	<script src="https://d3js.org/d3.v4.min.js"></script>
	<script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
	<script src="breadcrumb.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

	<select id="json_sources" name="json_sources" content-type="text/plain">
		<option value="" selected>---Select data---</option>
		<option value='{"data": "adj_1.json", "table": "1_table.txt"}'>adj IntClust 1</option>
		<option value='{"data": "adj_2.json", "table": "2_table.txt"}'>adj IntClust 2</option>
		<option value='{"data": "adj_3.json", "table": "3_table.txt"}'>adj IntClust 3</option>
		<option value='{"data": "adj_4ER+.json", "table": "4ER+_table.txt"}'>adj IntClust 4ER+</option>
		<option value='{"data": "adj_4ER-.json", "table": "4ER-_table.txt"}'>adj IntClust 4ER-</option>
		<option value='{"data": "adj_5.json", "table": "5_table.txt"}'>adj IntClust 5</option>
		<option value='{"data": "adj_6.json", "table": "6_table.txt"}'>adj IntClust 6</option>
		<option value='{"data": "adj_7.json", "table": "7_table.txt"}'>adj IntClust 7</option>
		<option value='{"data": "adj_8.json", "table": "8_table.txt"}'>adj IntClust 8</option>
		<option value='{"data": "adj_9.json", "table": "9_table.txt"}'>adj IntClust 9</option>
		<option value='{"data": "adj_10.json", "table": "10_table.txt"}'>adj IntClust 10</option>
		<option value='{"data": "adj_ER.json", "table": "ER_table.txt"}'>adj ER Status</option>
		<option value='{"data": "adj_PR.json", "table": "PR_table.txt"}'>adj PR Status</option>
		<option value='{"data": "adj_HER2.json", "table": "HER2_table.txt"}'>adj HER2 Status</option>
		<option value='{"data": "adj_Triple_Negative.json", "table": "Triple_Negative_table.txt"}'>adj Triple Neg Status</option>

	</select>â€‹
	<div id="factbox" class="hidden"></div>

	<script>
		var margin = {top: 20, right: 20, bottom: 20, left: 20},
			width = window.innerWidth - margin.left - margin.right,
			height = 0.95*(window.innerHeight) - margin.top - margin.bottom; // Use the window's height

		var radius = (Math.min(width, height) / 2) - 10;

		var charHight = 2 * radius - 100
		var charWidth = width - 2 * radius - margin.right

		var formatNumber = d3.format(",d");

		var x = d3.scaleLinear()
			.range([0, 2 * Math.PI]);

		var y = d3.scaleSqrt()
			.range([0, radius]);

		var color = d3.scaleLinear()
			.domain([0.0, 3.0, 50])
			.range(["white", 'white', 'red']);


		var partition = d3.partition();

		var arc = d3.arc()
			.startAngle(function(d) {return Math.max(0, Math.min(2 * Math.PI, x(d.x0)));})
			.endAngle(function(d) {return Math.max(0, Math.min(2 * Math.PI, x(d.x1)));})
			.innerRadius(function(d) {return Math.max(0, y(d.y0));})
			.outerRadius(function(d) {return Math.max(0, y(d.y1));});

		var svg = d3.select("body").append("svg")
			.attr("width", width)
			.attr("height", height)
			.attr("id", "full-canvas")
			.append("g")
			.attr("id", "container")
			.attr("transform", "translate(" + radius + "," + (height / 2) + ")");


		var breadcrumb = d3.breadcrumb()
			.container('svg').wrapWidth(width * 2 / 3) // any element or selection

		var legend = d3.select('svg')
			.append("g")
			.selectAll("g")
			.data(Array.apply(null, {
				length: 500
			}).map(Number.call, Number).map(function(x) {
				return x * 30 / 500
			}))
			.enter()
			//.innerHTML += 'legend'
			.append('g')
			.attr('class', 'legend')
			.attr('transform', function(d, i) {
				var height = legendRectSize;
				var x = i * 1;
				var y = 2 * radius - 10
				return 'translate(' + x + ',' + y + ')';

				var legendtitle = d3.select(svg)
					.append('legend')
					.select('legend')
					.text('Legend')
			});

		var legendRectSize = 10
		var legendSpacing = 0.001

		var table = d3.select('#table');

		d3.select("#json_sources").on('change', draw)

	function draw() {
			source = d3.select("#json_sources").property('value')
			const obj = JSON.parse(source);
			svg.selectAll('path').remove()
			d3.json(obj.data, function(error, dataset) {
				if (error) throw error;

				root = d3.hierarchy(dataset);

				root.sum(function(d) {return d.children ? 0 : d.ngenes; });

				var color_threshold = root.data.max_val
				var color_start = 3

				var color = d3.scaleLinear()
					.domain([0.0, color_start, color_threshold])
					.range(["white", 'white', 'red']);

				svg.selectAll("path")
					.data(partition(root).descendants())
					.enter().append("path")
					.attr("d", arc)
					.attr("id", "sunburst")
					.style("fill", function(d) {return color(d.data.value); })
					.style('stroke', 'black')
					.attr('stroke-width', 1)
					.attr("stroke-opacity", 0.2)
					.on("mouseover", mouseover)
					.on("mouseout", mouseout)
					.on("click", click);

				jQuery("#table").load(obj.table).attr('id', 'table')

				document.getElementById('factbox').innerHTML = "Maximum -log10(q-value) = " + color_threshold.toPrecision(5) + "</br>" +
					"Colored pathways have -log10(qvalue) > " + color_start.toPrecision(4) + "</br>";

			})

			legend.append('rect')
				.attr('width', legendRectSize)
				.attr('height', legendRectSize)
				.style('fill', color)
				.style('stroke', color);




		}


		function click(d) {

			svg.selectAll(".axis").remove();
			svg.selectAll(".grid").remove();

			svg.transition()
				.duration(500)
				.tween("scale", function() {
					var xd = d3.interpolate(x.domain(), [d.x0, d.x1]),
						yd = d3.interpolate(y.domain(), [d.y0, 1]),
						yr = d3.interpolate(y.range(), [d.y0 ? 20 : 0, radius]);
					return function(t) {
						x.domain(xd(t));
						y.domain(yd(t)).range(yr(t));};
				})
				.selectAll("path")
				.attrTween("d", function(d) {
					return function() {
						return arc(d);};
				});

	}

		function mouseover(d) {

			d3.select("#tooltip")
				.style("left", d3.event.pageX + "px")
				.style("top", d3.event.pageY + "px")
				.style("opacity", .9)
				.style("position", "absolute")
				.html(d.data.source + "</br>" + formatNumber(d.data.ngenes) + " genes </br>log10(q) = " + d.data.value + "</br> rank: " + formatNumber(d.data.rank));

			d3.select("#tooltip").classed("hidden", false);
		}

		function mouseout(d) {
			d3.select("#tooltip").classed("hidden", true);
		}
		// gridlines in x axis function
		function make_x_gridlines() {
		    return d3.axisBottom(xScale)
		        .ticks(10)
		}

		// gridlines in y axis function
		function make_y_gridlines() {
		    return d3.axisLeft(yScale)
		        .ticks(10)
		}

		d3.select(self.frameElement).style("height", height + "px");
	</script>
<!-- Transition: <input type="number" id="transitionValue" value="-1.5"> <button onclick="draw()">change</button>
-->
